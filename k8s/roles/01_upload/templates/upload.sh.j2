#!/bin/bash

export PUBLISH=/root/magma/orc8r/tools/docker/publish.sh
export MAGMA_TAG=1.3.0-master
export COMPOSE_PROJECT_NAME="orc8r"
#source /root/.bashrc
docker stop registry 2>/dev/null
docker rm registry 2>/dev/null
docker run -d -p 5000:5000 --restart=always --name registry registry:2



cat << EOF > /etc/docker/daemon.json 
{ "insecure-registries":["{{ registery_url }}"] }
EOF
    
systemctl restart docker


if [ ! -z "$1" ]; then
    # Upload orc8r
    cd /root/magma/orc8r/cloud/docker
    for image in controller nginx ; do ${PUBLISH} -r {{ registery_url }} -i ${image} -v ${MAGMA_TAG} ; done

    # Upload nms
    cd /root/magma/nms/app/packages/magmalte
    COMPOSE_PROJECT_NAME=orc8r ${PUBLISH} -r {{ registery_url }} -i magmalte -v ${MAGMA_TAG}
fi

